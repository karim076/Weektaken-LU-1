<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>
<body class="bg-light">
    <%- include('../partials/navbar') %>
    
    <div class="container mt-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
                <li class="breadcrumb-item active">Mijn Verhuur</li>
            </ol>
        </nav>
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h1 class="h3 mb-0">
                                    <i class="bi bi-film"></i>
                                    Mijn Verhuur
                                </h1>
                                <p class="mb-0">Bekijk je huidige en eerdere verhuur</p>
                            </div>
                            <a href="/films" class="btn btn-light">
                                <i class="bi bi-plus-circle"></i>
                                Nieuwe Film Huren
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <% if (stats) { %>
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <i class="bi bi-clock-history fs-1 text-warning mb-2"></i>
                        <h4 class="text-warning"><%= stats.pending || 0 %></h4>
                        <small class="text-muted">In Behandeling</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <i class="bi bi-credit-card fs-1 text-success mb-2"></i>
                        <h4 class="text-success"><%= stats.paid || 0 %></h4>
                        <small class="text-muted">Betaald</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <i class="bi bi-film fs-1 text-primary mb-2"></i>
                        <h4 class="text-primary"><%= stats.rented || 0 %></h4>
                        <small class="text-muted">Gehuurd</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <i class="bi bi-check-circle fs-1 text-info mb-2"></i>
                        <h4 class="text-info"><%= stats.returned || 0 %></h4>
                        <small class="text-muted">Teruggebracht</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Financial Stats -->
        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="card text-center h-100 border-success">
                    <div class="card-body">
                        <i class="bi bi-currency-euro fs-1 text-success mb-2"></i>
                        <h3 class="text-success">€<%= (stats.total_spent || 0).toFixed(2) %></h3>
                        <small class="text-muted">Totaal Uitgegeven</small>
                        <div class="mt-2">
                            <small class="badge bg-light text-muted">
                                <%= stats.total_rentals || 0 %> verhuur(en)
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center h-100 border-primary">
                    <div class="card-body">
                        <i class="bi bi-wallet2 fs-1 text-primary mb-2"></i>
                        <h4 class="text-primary">€<%= (stats.paid_amount || 0).toFixed(2) %></h4>
                        <small class="text-muted">Actieve Betalingen</small>
                        <div class="mt-2">
                            <small class="text-muted">Films nog in bezit</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center h-100 border-info">
                    <div class="card-body">
                        <i class="bi bi-check-circle-fill fs-1 text-info mb-2"></i>
                        <h4 class="text-info">€<%= (stats.completed_amount || 0).toFixed(2) %></h4>
                        <small class="text-muted">Voltooide Verhuur</small>
                        <div class="mt-2">
                            <small class="text-muted">Reeds teruggebracht</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <% } %>

        <!-- Rentals List -->
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history text-primary"></i>
                    Verhuur Geschiedenis
                </h5>
            </div>
            <div class="card-body">
                <% if (rentals && rentals.length > 0) { %>
                    <div class="row g-3">
                        <% rentals.forEach(rental => { %>
                            <div class="col-12">
                                <div class="card">  
                                    <div class="card-body">
                                        <div class="row align-items-center">
                                            <!-- Film Icon & Info -->
                                            <div class="col-auto">
                                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                                     style="width: 60px; height: 60px;">
                                                    <i class="bi bi-film fs-4"></i>
                                                </div>
                                            </div>
                                            
                                            <!-- Film Details -->
                                            <div class="col">
                                                <div class="row">
                                                    <div class="col-md-3">
                                                        <h6 class="mb-1">
                                                            <%= rental.title || rental.film_title %>
                                                        </h6>
                                                        <small class="text-muted">
                                                            <i class="bi bi-tag"></i> 
                                                            <%= rental.category %>
                                                        </small>
                                                    </div>
                                                    
                                                    <div class="col-md-2">
                                                        <small class="text-muted d-block">Gehuurd op</small>
                                                        <span class="fw-medium">
                                                            <%= new Date(rental.rental_date).toLocaleDateString('nl-NL') %>
                                                        </span>
                                                    </div>
                                                    
                                                    <div class="col-md-3">
                                                        <small class="text-muted d-block">Filmprijs</small>
                                                        <span class="fw-medium text-info">
                                                            €<%= parseFloat(rental.rental_rate || rental.amount || 0).toFixed(2) %>
                                                        </span>
                                                        <div class="mt-1">
                                                            <small class="text-muted">Per verhuurperiode</small>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-md-3">
                                                        <small class="text-muted d-block">Status</small>
                                                        <% if (rental.status === 'pending') { %>
                                                            <span class="badge bg-warning text-dark">
                                                                <i class="bi bi-clock"></i> Te Betalen
                                                            </span>
                                                            <div class="mt-1">
                                                                <small class="text-danger fw-bold">
                                                                    Nog te betalen: €<%= parseFloat(rental.amount || 0).toFixed(2) %>
                                                                </small>
                                                            </div>
                                                        <% } else if (rental.status === 'paid') { %>
                                                            <span class="badge bg-success">
                                                                <i class="bi bi-check-circle"></i> Betaald
                                                            </span>
                                                            <div class="mt-1">
                                                                <small class="text-success">
                                                                    Klaar om op te halen
                                                                </small>
                                                            </div>
                                                        <% } else if (rental.status === 'rented') { %>
                                                            <span class="badge bg-primary">
                                                                <i class="bi bi-play-circle"></i> Actief Gehuurd
                                                            </span>
                                                            <div class="mt-1">
                                                                <small class="text-primary">
                                                                    In uw bezit
                                                                </small>
                                                            </div>
                                                        <% } else if (rental.status === 'returned') { %>
                                                            <span class="badge bg-info">
                                                                <i class="bi bi-check2-circle"></i> Voltooid
                                                            </span>
                                                            <div class="mt-1">
                                                                <small class="text-info">
                                                                    Teruggebracht
                                                                </small>
                                                            </div>
                                                        <% } else { %>
                                                            <span class="badge bg-secondary">
                                                                <i class="bi bi-question-circle"></i> <%= rental.status %>
                                                            </span>
                                                        <% } %>
                                                    </div>
                                                    
                                                    <div class="col-md-2">
                                                        <small class="text-muted d-block">Totaal Bedrag</small>
                                                        <span class="h6 mb-0 <%= rental.status === 'pending' ? 'text-danger' : 'text-success' %>">
                                                            €<%= parseFloat(rental.amount || 0).toFixed(2) %>
                                                        </span>
                                                        <% if (rental.status === 'pending') { %>
                                                            <div class="mt-1">
                                                                <small class="text-muted">Nog niet betaald</small>
                                                            </div>
                                                        <% } else if (rental.status === 'returned') { %>
                                                            <div class="mt-1">
                                                                <small class="text-muted">Afgerond</small>
                                                            </div>
                                                        <% } else { %>
                                                            <div class="mt-1">
                                                                <small class="text-success">Betaald</small>
                                                            </div>
                                                        <% } %>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Actions -->
                                            <div class="col-auto">
                                                <div class="dropdown">
                                                    <button class="btn btn-outline-primary btn-sm dropdown-toggle" 
                                                            type="button" data-bs-toggle="dropdown">
                                                        <i class="bi bi-three-dots"></i>
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        <li>
                                                            <a class="dropdown-item" 
                                                                href="/customer/rentals/<%= rental.rental_id %>">
                                                                <i class="bi bi-eye"></i> Details Bekijken
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <a class="dropdown-item" 
                                                                href="/films/<%= rental.film_id %>">
                                                                <i class="bi bi-info-circle"></i> Film Info
                                                            </a>
                                                        </li>
                                                        <% if (rental.status === 'pending') { %>
                                                        <li><hr class="dropdown-divider"></li>
                                                        <li>
                                                            <a class="dropdown-item text-warning" 
                                                                href="#" 
                                                                onclick="payRental('<%= rental.rental_id %>')">
                                                                <i class="bi bi-credit-card"></i> Nu Betalen (€<%= parseFloat(rental.amount || 0).toFixed(2) %>)
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <a class="dropdown-item text-danger" 
                                                                href="#" 
                                                                onclick="cancelRental('<%= rental.rental_id %>', '<%= rental.film_title %>')">
                                                                <i class="bi bi-x-circle"></i> Verhuur Annuleren
                                                            </a>
                                                        </li>
                                                        <% } else if (rental.status === 'returned') { %>
                                                        <li><hr class="dropdown-divider"></li>
                                                        <li>
                                                            <a class="dropdown-item text-success" href="/films">
                                                                <i class="bi bi-arrow-repeat"></i> Opnieuw Huren
                                                            </a>
                                                        </li>
                                                        <% } else if (rental.status === 'rented') { %>
                                                        <li><hr class="dropdown-divider"></li>
                                                        <li>
                                                            <a class="dropdown-item text-info" href="/contact">
                                                                <i class="bi bi-arrow-return-left"></i> Terugbrengen
                                                            </a>
                                                        </li>
                                                        <% } %>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Additional Status Info -->
                                        <div class="row mt-3">
                                            <div class="col-12">
                                                <% if (rental.status === 'pending') { %>
                                                    <div class="alert alert-warning py-2 mb-0">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <i class="bi bi-exclamation-triangle"></i>
                                                                <strong>Actie vereist:</strong> Betaling van €<%= parseFloat(rental.amount || 0).toFixed(2) %> om verhuur te activeren
                                                            </div>
                                                            <button class="btn btn-warning btn-sm" onclick="payRental('<%= rental.rental_id %>')">
                                                                <i class="bi bi-credit-card"></i> Nu Betalen
                                                            </button>
                                                        </div>
                                                    </div>
                                                <% } else if (rental.status === 'paid') { %>
                                                    <div class="alert alert-success py-2 mb-0">
                                                        <i class="bi bi-check-circle"></i>
                                                        <strong>Betaling voltooid!</strong> U kunt de film ophalen bij onze locatie
                                                    </div>
                                                <% } else if (rental.status === 'rented' && rental.expected_return_date) { %>
                                                    <% 
                                                        const today = new Date();
                                                        const returnDate = new Date(rental.expected_return_date);
                                                        const daysLeft = Math.ceil((returnDate - today) / (1000 * 60 * 60 * 24));
                                                    %>
                                                    <% if (daysLeft < 0) { %>
                                                        <div class="alert alert-danger py-2 mb-0">
                                                            <i class="bi bi-exclamation-circle"></i>
                                                            <strong>Te laat!</strong> Film is <%= Math.abs(daysLeft) %> dag(en) over tijd. Breng zo snel mogelijk terug om extra kosten te voorkomen.
                                                        </div>
                                                    <% } else if (daysLeft <= 1) { %>
                                                        <div class="alert alert-warning py-2 mb-0">
                                                            <i class="bi bi-clock"></i>
                                                            <strong>Binnenkort inleveren!</strong> Terugbrengen voor <%= new Date(rental.expected_return_date).toLocaleDateString('nl-NL') %>
                                                        </div>
                                                    <% } else { %>
                                                        <div class="alert alert-info py-2 mb-0">
                                                            <i class="bi bi-calendar"></i>
                                                            <strong>Actief gehuurd.</strong> Terugbrengen voor <%= new Date(rental.expected_return_date).toLocaleDateString('nl-NL') %> (<%= daysLeft %> dagen)
                                                        </div>
                                                    <% } %>
                                                <% } else if (rental.status === 'returned') { %>
                                                    <div class="alert alert-light py-2 mb-0">
                                                        <i class="bi bi-check-circle-fill text-success"></i>
                                                        <strong>Verhuur voltooid.</strong> 
                                                        Teruggebracht op <%= new Date(rental.return_date).toLocaleDateString('nl-NL') %>
                                                    </div>
                                                <% } %>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                    
                    <!-- Pagination -->
                    <% if (pagination && pagination.totalPages > 1) { %>
                        <nav aria-label="Page navigation" class="mt-4">
                            <ul class="pagination justify-content-center">
                                <% if (pagination.currentPage > 1) { %>
                                    <li class="page-item">
                                        <a class="page-link" href="?page=<%= pagination.currentPage - 1 %>">
                                            <i class="bi bi-chevron-left"></i> Vorige
                                        </a>
                                    </li>
                                <% } %>
                                
                                <% for (let i = 1; i <= pagination.totalPages; i++) { %>
                                    <li class="page-item <%= i === pagination.currentPage ? 'active' : '' %>">
                                        <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                                    </li>
                                <% } %>
                                
                                <% if (pagination.currentPage < pagination.totalPages) { %>
                                    <li class="page-item">
                                        <a class="page-link" href="?page=<%= pagination.currentPage + 1 %>">
                                            Volgende <i class="bi bi-chevron-right"></i>
                                        </a>
                                    </li>
                                <% } %>
                            </ul>
                        </nav>
                    <% } %>
                <% } else { %>
                    <div class="text-center py-5">
                        <i class="bi bi-film display-1 text-muted mb-3"></i>
                        <h3 class="text-muted">Geen verhuur gevonden</h3>
                        <p class="text-muted">Je hebt nog geen films gehuurd.</p>
                        <a href="/films" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i>
                            Huur je eerste film
                        </a>
                    </div>
                <% } %>
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>
    
    <!-- Cancel Rental Modal -->
    <div class="modal fade" id="cancelRentalModal" tabindex="-1" aria-labelledby="cancelRentalModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="cancelRentalModalLabel">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        Verhuur Annuleren
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="bi bi-question-circle-fill text-warning" style="font-size: 3rem;"></i>
                    </div>
                    <h6 class="text-center mb-3">Weet je zeker dat je deze verhuur wilt annuleren?</h6>
                    <div class="alert alert-info">
                        <strong>Film:</strong> <span id="modalFilmTitle"></span><br>
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            Deze actie kan niet ongedaan worden gemaakt. De film komt weer beschikbaar voor andere klanten.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i>
                        Nee, Behouden
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmCancelBtn">
                        <i class="bi bi-trash"></i>
                        Ja, Annuleren
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let currentRentalId = null;
        let currentFilmTitle = null;
        const cancelModal = new bootstrap.Modal(document.getElementById('cancelRentalModal'));
        
        function cancelRental(rentalId, filmTitle) {
            currentRentalId = rentalId;
            currentFilmTitle = filmTitle;
            
            // Update modal content
            document.getElementById('modalFilmTitle').textContent = filmTitle;
            
            // Show the modal
            cancelModal.show();
        }
        
        // Handle confirm button click
        document.getElementById('confirmCancelBtn').addEventListener('click', function() {
            if (!currentRentalId) return;
            
            // Disable button and show loading state
            const btn = this;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Annuleren...';
            
            console.log('Cancelling rental:', currentRentalId);
            
            fetch(`/customer/rentals/${currentRentalId}/cancel`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                
                if (data.success) {
                    // Hide modal
                    cancelModal.hide();
                    
                    // Show success toast
                    showToast('success', 'Geannuleerd!', data.message);
                    
                    // Reload page after a short delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    // Show error toast
                    showToast('error', 'Fout!', data.message);
                }
            })
            .catch(error => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                console.error('Error:', error);
                showToast('error', 'Fout!', 'Er is een fout opgetreden bij het annuleren van de verhuur');
            });
        });
        
        // Payment function
        window.payRental = function(rentalId, amount) {
            if (confirm(`Wilt u €${amount} betalen voor deze verhuur?`)) {
                // Simulate payment process
                fetch(`/customer/rentals/${rentalId}/pay`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ amount: amount })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('success', 'Betaling Gelukt!', `€${amount} is succesvol betaald`);
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        showToast('error', 'Betaling Mislukt!', data.message || 'Er is een fout opgetreden bij de betaling');
                    }
                })
                .catch(error => {
                    console.error('Payment error:', error);
                    showToast('error', 'Betaling Mislukt!', 'Er is een fout opgetreden bij de betaling');
                });
            }
        };
        
        // Return rental function
        window.returnRental = function(rentalId, filmTitle) {
            if (confirm(`Wilt u "${filmTitle}" inleveren?`)) {
                fetch(`/customer/rentals/${rentalId}/return`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('success', 'Ingeleverd!', `"${filmTitle}" is succesvol ingeleverd`);
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        showToast('error', 'Inleveren Mislukt!', data.message || 'Er is een fout opgetreden bij het inleveren');
                    }
                })
                .catch(error => {
                    console.error('Return error:', error);
                    showToast('error', 'Inleveren Mislukt!', 'Er is een fout opgetreden bij het inleveren');
                });
            }
        };
        
        // Extend rental function
        window.extendRental = function(rentalId, filmTitle) {
            if (confirm(`Wilt u de verhuur van "${filmTitle}" verlengen?`)) {
                fetch(`/customer/rentals/${rentalId}/extend`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('success', 'Verlengd!', `Verhuur van "${filmTitle}" is verlengd`);
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        showToast('error', 'Verlengen Mislukt!', data.message || 'Er is een fout opgetreden bij het verlengen');
                    }
                })
                .catch(error => {
                    console.error('Extend error:', error);
                    showToast('error', 'Verlengen Mislukt!', 'Er is een fout opgetreden bij het verlengen');
                });
            }
        };
        
        // View details function
        window.viewDetails = function(rentalId) {
            // Redirect to rental details page
            window.location.href = `/customer/rentals/${rentalId}`;
        };
        
        // Contact support function
        window.contactSupport = function(rentalId) {
            const subject = `Vraag over verhuur #${rentalId}`;
            const body = `Hallo,\n\nIk heb een vraag over mijn verhuur met ID: ${rentalId}.\n\nMijn vraag is:\n\n\nMet vriendelijke groet`;
            const mailtoLink = `mailto:support@sakilafilms.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
        };
        
        // Toast notification function
        function showToast(type, title, message) {
            const toastContainer = document.getElementById('toastContainer') || createToastContainer();
            
            const toastId = 'toast-' + Date.now();
            const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';
            const icon = type === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-triangle-fill';
            
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi ${icon} me-2"></i>í
                            <strong>${title}</strong> ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: type === 'success' ? 3000 : 5000
            });
            
            toast.show();
            
            // Remove toast element after it's hidden
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }
        
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
            return container;
        }
    </script>
</body>
</html>
