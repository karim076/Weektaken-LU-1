<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>
<body class="bg-light">
    <%- include('../partials/navbar') %>
    
    <div class="container mt-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
                <li class="breadcrumb-item active">Mijn Verhuur</li>
            </ol>
        </nav>
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h1 class="h3 mb-0">
                                    <i class="bi bi-film"></i>
                                    Mijn Verhuur
                                </h1>
                                <p class="mb-0">Bekijk je huidige en eerdere verhuur</p>
                            </div>
                            <a href="/films" class="btn btn-light">
                                <i class="bi bi-plus-circle"></i>
                                Nieuwe Film Huren
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <% if (stats) { %>
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <i class="bi bi-hourglass-half fs-1 text-warning mb-2"></i>
                        <h4 class="text-warning"><%= (stats.processing || 0) + (stats.pending || 0) %></h4>
                        <small class="text-muted">In Behandeling/Te Betalen</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <i class="bi bi-credit-card fs-1 text-success mb-2"></i>
                        <h4 class="text-success"><%= stats.paid || 0 %></h4>
                        <small class="text-muted">Betaald</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <i class="bi bi-film fs-1 text-primary mb-2"></i>
                        <h4 class="text-primary"><%= stats.rented || 0 %></h4>
                        <small class="text-muted">Actief Gehuurd</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <i class="bi bi-check-circle fs-1 text-info mb-2"></i>
                        <h4 class="text-info"><%= stats.returned || 0 %></h4>
                        <small class="text-muted">Voltooid</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Financial Stats -->
        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="card text-center h-100 border-success">
                    <div class="card-body">
                        <i class="bi bi-currency-euro fs-1 text-success mb-2"></i>
                        <h3 class="text-success">€<%= (stats.total_spent || 0).toFixed(2) %></h3>
                        <small class="text-muted">Totaal Uitgegeven</small>
                        <div class="mt-2">
                            <small class="badge bg-light text-muted">
                                <%= stats.total_rentals || 0 %> verhuur(en)
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center h-100 border-primary">
                    <div class="card-body">
                        <i class="bi bi-wallet2 fs-1 text-primary mb-2"></i>
                        <h4 class="text-primary">€<%= (stats.paid_amount || 0).toFixed(2) %></h4>
                        <small class="text-muted">Actieve Betalingen</small>
                        <div class="mt-2">
                            <small class="text-muted">Films nog in bezit</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center h-100 border-info">
                    <div class="card-body">
                        <i class="bi bi-check-circle-fill fs-1 text-info mb-2"></i>
                        <h4 class="text-info">€<%= (stats.completed_amount || 0).toFixed(2) %></h4>
                        <small class="text-muted">Voltooide Verhuur</small>
                        <div class="mt-2">
                            <small class="text-muted">Reeds teruggebracht</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <% } %>

        <!-- Rentals List -->
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history text-primary"></i>
                    Verhuur Geschiedenis
                </h5>
            </div>
            <div class="card-body">
                <% if (rentals && rentals.length > 0) { %>
                    <div class="row g-3">
                        <% rentals.forEach(rental => { %>
                            <div class="col-12">
                                <div class="card">  
                                    <div class="card-body">
                                        <div class="row align-items-center">
                                            <!-- Film Icon & Info -->
                                            <div class="col-auto">
                                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                                     style="width: 60px; height: 60px;">
                                                    <i class="bi bi-film fs-4"></i>
                                                </div>
                                            </div>
                                            
                                            <!-- Film Details -->
                                            <div class="col">
                                                <div class="row">
                                                    <div class="col-md-3">
                                                        <h6 class="mb-1">
                                                            <%= rental.title || rental.film_title %>
                                                        </h6>
                                                        <small class="text-muted">
                                                            <i class="bi bi-tag"></i> 
                                                            <%= rental.category %>
                                                        </small>
                                                    </div>
                                                    
                                                    <div class="col-md-2">
                                                        <small class="text-muted d-block">Gehuurd op</small>
                                                        <span class="fw-medium">
                                                            <%= new Date(rental.rental_date).toLocaleDateString('nl-NL') %>
                                                        </span>
                                                    </div>
                                                    
                                                    <div class="col-md-3">
                                                        <small class="text-muted d-block">Filmprijs</small>
                                                        <span class="fw-medium text-info">
                                                            €<%= parseFloat(rental.rental_rate || rental.amount || 0).toFixed(2) %>
                                                        </span>
                                                        <div class="mt-1">
                                                            <small class="text-muted">Per verhuurperiode</small>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-md-3">
                                                        <small class="text-muted d-block">Status</small>
                                                        <% if (rental.status === 'processing') { %>
                                                            <span class="badge status-processing">
                                                                <span class="status-dot processing"></span>
                                                                <i class="bi bi-hourglass-half"></i> In Behandeling
                                                            </span>
                                                            <div class="mt-1">
                                                                <small class="text-warning fw-bold">
                                                                    Wordt verwerkt...
                                                                </small>
                                                            </div>
                                                        <% } else if (rental.status === 'pending') { %>
                                                            <span class="badge status-pending">
                                                                <span class="status-dot pending"></span>
                                                                <i class="bi bi-exclamation-circle"></i> Te Betalen
                                                            </span>
                                                            <div class="mt-1">
                                                                <small class="text-danger fw-bold">
                                                                    Nog te betalen: €<%= parseFloat(rental.amount || 0).toFixed(2) %>
                                                                </small>
                                                            </div>
                                                        <% } else if (rental.status === 'paid') { %>
                                                            <span class="badge status-paid">
                                                                <span class="status-dot paid"></span>
                                                                <i class="bi bi-check-circle"></i> Betaald
                                                            </span>
                                                            <div class="mt-1">
                                                                <small class="text-success">
                                                                    Klaar om op te halen
                                                                </small>
                                                            </div>
                                                        <% } else if (rental.status === 'rented') { %>
                                                            <span class="badge status-rented">
                                                                <span class="status-dot rented"></span>
                                                                <i class="bi bi-play-circle"></i> Actief Gehuurd
                                                            </span>
                                                            <div class="mt-1">
                                                                <small class="text-primary">
                                                                    In uw bezit
                                                                </small>
                                                            </div>
                                                        <% } else if (rental.status === 'returned') { %>
                                                            <span class="badge status-returned">
                                                                <span class="status-dot returned"></span>
                                                                <i class="bi bi-check2-circle"></i> Voltooid
                                                            </span>
                                                            <div class="mt-1">
                                                                <small class="text-info">
                                                                    Teruggebracht
                                                                </small>
                                                            </div>
                                                        <% } else { %>
                                                            <span class="badge bg-secondary">
                                                                <i class="bi bi-question-circle"></i> <%= rental.status %>
                                                            </span>
                                                        <% } %>
                                                    </div>
                                                    
                                                    <div class="col-md-2">
                                                        <small class="text-muted d-block">Totaal Bedrag</small>
                                                        <span class="h6 mb-0 <%= rental.status === 'pending' ? 'text-danger' : 'text-success' %>">
                                                            €<%= parseFloat(rental.amount || 0).toFixed(2) %>
                                                        </span>
                                                        <% if (rental.status === 'pending') { %>
                                                            <div class="mt-1">
                                                                <small class="text-muted">Nog niet betaald</small>
                                                            </div>
                                                        <% } else if (rental.status === 'returned') { %>
                                                            <div class="mt-1">
                                                                <small class="text-muted">Afgerond</small>
                                                            </div>
                                                        <% } else { %>
                                                            <div class="mt-1">
                                                                <small class="text-success">Betaald</small>
                                                            </div>
                                                        <% } %>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Actions -->
                                            <div class="col-auto">
                                                <div class="dropdown">
                                                    <button class="btn btn-outline-primary btn-sm dropdown-toggle" 
                                                            type="button" data-bs-toggle="dropdown">
                                                        <i class="bi bi-three-dots"></i>
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        <li>
                                                            <a class="dropdown-item" 
                                                                href="/customer/rentals/<%= rental.rental_id %>">
                                                                <i class="bi bi-eye"></i> Details Bekijken
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <a class="dropdown-item" 
                                                                href="/films/<%= rental.film_id %>">
                                                                <i class="bi bi-info-circle"></i> Film Info
                                                            </a>
                                                        </li>
                                                        <% if (rental.status === 'processing') { %>
                                                        <li><hr class="dropdown-divider"></li>
                                                        <li>
                                                            <a class="dropdown-item text-danger" 
                                                                href="#" 
                                                                onclick="cancelRental('<%= rental.rental_id %>', '<%= rental.film_title %>')">
                                                                <i class="bi bi-x-circle"></i> Verhuur Annuleren
                                                            </a>
                                                        </li>
                                                        <% } else if (rental.status === 'pending') { %>
                                                        <li><hr class="dropdown-divider"></li>
                                                        <li>
                                                            <a class="dropdown-item text-warning" 
                                                                href="#" 
                                                                onclick="payRental('<%= rental.rental_id %>')">
                                                                <i class="bi bi-credit-card"></i> Nu Betalen (€<%= parseFloat(rental.amount || 0).toFixed(2) %>)
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <a class="dropdown-item text-danger" 
                                                                href="#" 
                                                                onclick="cancelRental('<%= rental.rental_id %>', '<%= rental.film_title %>')">
                                                                <i class="bi bi-x-circle"></i> Verhuur Annuleren
                                                            </a>
                                                        </li>
                                                        <% } else if (rental.status === 'returned') { %>
                                                        <li><hr class="dropdown-divider"></li>
                                                        <li>
                                                            <a class="dropdown-item text-success" href="/films">
                                                                <i class="bi bi-arrow-repeat"></i> Opnieuw Huren
                                                            </a>
                                                        </li>
                                                        <% } else if (rental.status === 'rented') { %>
                                                        <li><hr class="dropdown-divider"></li>
                                                        <li>
                                                            <a class="dropdown-item text-info" href="/contact">
                                                                <i class="bi bi-arrow-return-left"></i> Terugbrengen
                                                            </a>
                                                        </li>
                                                        <% } %>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Additional Status Info -->
                                        <div class="row mt-3">
                                            <div class="col-12">
                                                <% if (rental.status === 'processing') { %>
                                                    <div class="alert rental-processing py-2 mb-0">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <i class="bi bi-hourglass-half"></i>
                                                                <strong>In behandeling:</strong> Uw verhuur wordt momenteel verwerkt. U kunt deze nog annuleren.
                                                            </div>
                                                            <button class="btn btn-cancel-rental btn-sm" onclick="cancelRental('<%= rental.rental_id %>', '<%= rental.film_title %>')">
                                                                <i class="bi bi-x-circle"></i> Annuleren
                                                            </button>
                                                        </div>
                                                    </div>
                                                <% } else if (rental.status === 'pending') { %>
                                                    <div class="alert rental-pending py-2 mb-0">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <i class="bi bi-exclamation-triangle"></i>
                                                                <strong>Actie vereist:</strong> Betaling van €<%= parseFloat(rental.amount || 0).toFixed(2) %> om verhuur te activeren
                                                            </div>
                                                            <div class="btn-group">
                                                                <button class="btn btn-pay-rental btn-sm" onclick="payRental('<%= rental.rental_id %>')">
                                                                    <i class="bi bi-credit-card"></i> Nu Betalen
                                                                </button>
                                                                <button class="btn btn-cancel-rental btn-sm" onclick="cancelRental('<%= rental.rental_id %>', '<%= rental.film_title %>')">
                                                                    <i class="bi bi-x-circle"></i> Annuleren
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                <% } else if (rental.status === 'paid') { %>
                                                    <div class="alert alert-success py-2 mb-0">
                                                        <i class="bi bi-check-circle"></i>
                                                        <strong>Betaling voltooid!</strong> U kunt de film ophalen bij onze locatie
                                                    </div>
                                                <% } else if (rental.status === 'rented' && rental.expected_return_date) { %>
                                                    <% 
                                                        const today = new Date();
                                                        const returnDate = new Date(rental.expected_return_date);
                                                        const daysLeft = Math.ceil((returnDate - today) / (1000 * 60 * 60 * 24));
                                                    %>
                                                    <% if (daysLeft < 0) { %>
                                                        <div class="alert alert-danger py-2 mb-0">
                                                            <i class="bi bi-exclamation-circle"></i>
                                                            <strong>Te laat!</strong> Film is <%= Math.abs(daysLeft) %> dag(en) over tijd. Breng zo snel mogelijk terug om extra kosten te voorkomen.
                                                        </div>
                                                    <% } else if (daysLeft <= 1) { %>
                                                        <div class="alert alert-warning py-2 mb-0">
                                                            <i class="bi bi-clock"></i>
                                                            <strong>Binnenkort inleveren!</strong> Terugbrengen voor <%= new Date(rental.expected_return_date).toLocaleDateString('nl-NL') %>
                                                        </div>
                                                    <% } else { %>
                                                        <div class="alert alert-info py-2 mb-0">
                                                            <i class="bi bi-calendar"></i>
                                                            <strong>Actief gehuurd.</strong> Terugbrengen voor <%= new Date(rental.expected_return_date).toLocaleDateString('nl-NL') %> (<%= daysLeft %> dagen)
                                                        </div>
                                                    <% } %>
                                                <% } else if (rental.status === 'returned') { %>
                                                    <div class="alert alert-light py-2 mb-0">
                                                        <i class="bi bi-check-circle-fill text-success"></i>
                                                        <strong>Verhuur voltooid.</strong> 
                                                        Teruggebracht op <%= new Date(rental.return_date).toLocaleDateString('nl-NL') %>
                                                    </div>
                                                <% } %>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                    
                    <!-- Pagination -->
                    <% if (pagination && pagination.totalPages > 1) { %>
                        <nav aria-label="Page navigation" class="mt-4">
                            <ul class="pagination justify-content-center">
                                <% if (pagination.currentPage > 1) { %>
                                    <li class="page-item">
                                        <a class="page-link" href="?page=<%= pagination.currentPage - 1 %>">
                                            <i class="bi bi-chevron-left"></i> Vorige
                                        </a>
                                    </li>
                                <% } %>
                                
                                <% for (let i = 1; i <= pagination.totalPages; i++) { %>
                                    <li class="page-item <%= i === pagination.currentPage ? 'active' : '' %>">
                                        <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                                    </li>
                                <% } %>
                                
                                <% if (pagination.currentPage < pagination.totalPages) { %>
                                    <li class="page-item">
                                        <a class="page-link" href="?page=<%= pagination.currentPage + 1 %>">
                                            Volgende <i class="bi bi-chevron-right"></i>
                                        </a>
                                    </li>
                                <% } %>
                            </ul>
                        </nav>
                    <% } %>
                <% } else { %>
                    <div class="text-center py-5">
                        <i class="bi bi-film display-1 text-muted mb-3"></i>
                        <h3 class="text-muted">Geen verhuur gevonden</h3>
                        <p class="text-muted">Je hebt nog geen films gehuurd.</p>
                        <a href="/films" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i>
                            Huur je eerste film
                        </a>
                    </div>
                <% } %>
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>
    
    <!-- Cancel Rental Modal -->
    <div class="modal fade" id="cancelRentalModal" tabindex="-1" aria-labelledby="cancelRentalModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-gradient text-white border-0" style="background: linear-gradient(135deg, #dc3545 0%, #c21807 100%);">
                    <h5 class="modal-title d-flex align-items-center" id="cancelRentalModalLabel">
                        <div class="bg-white bg-opacity-20 rounded-circle p-2 me-3">
                            <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                        </div>
                        <div>
                            <div class="h5 mb-1">Verhuur Annuleren</div>
                            <small class="opacity-75">Bevestig je actie</small>
                        </div>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="text-center mb-4">
                        <div class="bg-warning bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                             style="width: 80px; height: 80px;">
                            <i class="bi bi-question-circle-fill text-warning" style="font-size: 2.5rem;"></i>
                        </div>
                        <h4 class="text-dark mb-2">Weet je dit zeker?</h4>
                        <p class="text-muted">Je staat op het punt om de volgende verhuur te annuleren:</p>
                    </div>
                    
                    <!-- Film Info Card -->
                    <div class="card bg-light border-0 mb-4">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-3" 
                                     style="width: 50px; height: 50px;">
                                    <i class="bi bi-film text-primary fs-4"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1 text-dark" id="modalFilmTitle">Film Titel</h6>
                                    <small class="text-muted">
                                        <i class="bi bi-clock me-1"></i>
                                        Status: <span class="badge bg-warning text-dark">In Behandeling</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Warning Info -->
                    <div class="alert alert-warning border-0 bg-warning bg-opacity-10">
                        <div class="d-flex">
                            <i class="bi bi-info-circle-fill text-warning me-3 mt-1"></i>
                            <div>
                                <h6 class="text-warning mb-2">Belangrijk om te weten:</h6>
                                <ul class="list-unstyled mb-0 small text-muted">
                                    <li class="mb-1">• Deze actie kan niet ongedaan worden gemaakt</li>
                                    <li class="mb-1">• De film komt weer beschikbaar voor andere klanten</li>
                                    <li class="mb-1">• Er worden geen kosten in rekening gebracht</li>
                                    <li>• Je kunt de film later opnieuw huren</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 bg-light p-4">
                    <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
                        <i class="bi bi-arrow-left me-2"></i>
                        Nee, Behouden
                    </button>
                    <button type="button" class="btn btn-danger px-4" id="confirmCancelBtn">
                        <i class="bi bi-trash me-2"></i>
                        <span id="confirmBtnText">Ja, Annuleren</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let currentRentalId = null;
        let currentFilmTitle = null;
        const cancelModal = new bootstrap.Modal(document.getElementById('cancelRentalModal'));
        
        function cancelRental(rentalId, filmTitle) {
            currentRentalId = rentalId;
            currentFilmTitle = filmTitle;
            
            // Find the rental data to show more details
            const rentalCard = document.querySelector(`[onclick*="${rentalId}"]`).closest('.card');
            const statusBadge = rentalCard.querySelector('.badge');
            const rentalDate = rentalCard.querySelector('.fw-medium').textContent;
            const amount = rentalCard.querySelector('.h6').textContent;
            
            // Update modal content with detailed information
            document.getElementById('modalFilmTitle').textContent = filmTitle;
            
            // Add rental details to modal if not already present
            const existingDetails = document.getElementById('modalRentalDetails');
            if (!existingDetails) {
                const modalBody = document.querySelector('#cancelRentalModal .modal-body');
                const filmInfoCard = modalBody.querySelector('.card');
                
                // Add extra details to the film info card
                const detailsDiv = document.createElement('div');
                detailsDiv.id = 'modalRentalDetails';
                detailsDiv.className = 'mt-2 pt-2 border-top';
                detailsDiv.innerHTML = `
                    <div class="row text-sm">
                        <div class="col-6">
                            <small class="text-muted">Gehuurd op:</small><br>
                            <small class="fw-medium">${rentalDate}</small>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Bedrag:</small><br>
                            <small class="fw-medium text-success">${amount}</small>
                        </div>
                    </div>
                `;
                
                filmInfoCard.querySelector('.card-body').appendChild(detailsDiv);
            } else {
                // Update existing details
                const rentalDateSpan = existingDetails.querySelector('.row .col-6:first-child .fw-medium');
                const amountSpan = existingDetails.querySelector('.row .col-6:last-child .fw-medium');
                rentalDateSpan.textContent = rentalDate;
                amountSpan.textContent = amount;
            }
            
            // Add entrance animation to modal
            const modalElement = document.getElementById('cancelRentalModal');
            modalElement.addEventListener('shown.bs.modal', function() {
                const modalContent = this.querySelector('.modal-content');
                modalContent.style.animation = 'modalSlideIn 0.3s ease-out';
            }, { once: true });
            
            // Show the modal
            cancelModal.show();
        }
        
        // Handle confirm button click
        document.getElementById('confirmCancelBtn').addEventListener('click', function() {
            if (!currentRentalId) return;
            
            // Disable button and show loading state with animation
            const btn = this;
            const btnText = document.getElementById('confirmBtnText');
            const originalText = btnText.innerHTML;
            
            btn.disabled = true;
            btn.classList.add('btn-loading');
            btnText.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Annuleren...';
            
            // Add shake animation to modal
            const modal = document.querySelector('#cancelRentalModal .modal-content');
            modal.classList.add('animate-processing');
            
            console.log('Cancelling rental:', currentRentalId);
            
            fetch(`/customer/rentals/${currentRentalId}/cancel`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.classList.remove('btn-loading');
                btnText.innerHTML = originalText;
                modal.classList.remove('animate-processing');
                
                if (data.success) {
                    // Success animation
                    modal.classList.add('animate-success');
                    btnText.innerHTML = '<i class="bi bi-check-circle me-2"></i>Geannuleerd!';
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-success');
                    
                    // Hide modal after animation
                    setTimeout(() => {
                        cancelModal.hide();
                        
                        // Show success toast with better styling
                        showEnhancedToast('success', 'Verhuur Geannuleerd!', data.message, 'bi-check-circle-fill');
                        
                        // Reload page after a short delay
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    }, 1000);
                } else {
                    // Error state
                    modal.classList.add('animate-error');
                    showEnhancedToast('error', 'Annulering Mislukt!', data.message, 'bi-exclamation-triangle-fill');
                    
                    setTimeout(() => {
                        modal.classList.remove('animate-error');
                    }, 1000);
                }
            })
            .catch(error => {
                btn.disabled = false;
                btn.classList.remove('btn-loading');
                btnText.innerHTML = originalText;
                modal.classList.remove('animate-processing');
                modal.classList.add('animate-error');
                
                console.error('Error:', error);
                showEnhancedToast('error', 'Verbindingsfout!', 'Er is een fout opgetreden bij het annuleren van de verhuur', 'bi-wifi-off');
                
                setTimeout(() => {
                    modal.classList.remove('animate-error');
                }, 1000);
            });
        });
        
        // Payment function
        window.payRental = function(rentalId, amount) {
            if (confirm(`Wilt u €${amount} betalen voor deze verhuur?`)) {
                // Simulate payment process
                fetch(`/customer/rentals/${rentalId}/pay`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ amount: amount })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('success', 'Betaling Gelukt!', `€${amount} is succesvol betaald`);
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        showToast('error', 'Betaling Mislukt!', data.message || 'Er is een fout opgetreden bij de betaling');
                    }
                })
                .catch(error => {
                    console.error('Payment error:', error);
                    showToast('error', 'Betaling Mislukt!', 'Er is een fout opgetreden bij de betaling');
                });
            }
        };
        
        // Return rental function
        window.returnRental = function(rentalId, filmTitle) {
            if (confirm(`Wilt u "${filmTitle}" inleveren?`)) {
                fetch(`/customer/rentals/${rentalId}/return`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('success', 'Ingeleverd!', `"${filmTitle}" is succesvol ingeleverd`);
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        showToast('error', 'Inleveren Mislukt!', data.message || 'Er is een fout opgetreden bij het inleveren');
                    }
                })
                .catch(error => {
                    console.error('Return error:', error);
                    showToast('error', 'Inleveren Mislukt!', 'Er is een fout opgetreden bij het inleveren');
                });
            }
        };
        
        // Extend rental function
        window.extendRental = function(rentalId, filmTitle) {
            if (confirm(`Wilt u de verhuur van "${filmTitle}" verlengen?`)) {
                fetch(`/customer/rentals/${rentalId}/extend`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('success', 'Verlengd!', `Verhuur van "${filmTitle}" is verlengd`);
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        showToast('error', 'Verlengen Mislukt!', data.message || 'Er is een fout opgetreden bij het verlengen');
                    }
                })
                .catch(error => {
                    console.error('Extend error:', error);
                    showToast('error', 'Verlengen Mislukt!', 'Er is een fout opgetreden bij het verlengen');
                });
            }
        };
        
        // View details function
        window.viewDetails = function(rentalId) {
            // Redirect to rental details page
            window.location.href = `/customer/rentals/${rentalId}`;
        };
        
        // Contact support function
        window.contactSupport = function(rentalId) {
            const subject = `Vraag over verhuur #${rentalId}`;
            const body = `Hallo,\n\nIk heb een vraag over mijn verhuur met ID: ${rentalId}.\n\nMijn vraag is:\n\n\nMet vriendelijke groet`;
            const mailtoLink = `mailto:support@sakilafilms.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
        };
        
        // Enhanced Toast notification function
        function showEnhancedToast(type, title, message, icon = '') {
            const toastContainer = document.getElementById('toastContainer') || createToastContainer();
            
            const toastId = 'toast-' + Date.now();
            const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-warning';
            const defaultIcon = type === 'success' ? 'bi-check-circle-fill' : type === 'error' ? 'bi-exclamation-triangle-fill' : 'bi-info-circle-fill';
            const finalIcon = icon || defaultIcon;
            
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0 enhanced-toast" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body d-flex align-items-center">
                            <div class="bg-white bg-opacity-20 rounded-circle p-2 me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                <i class="bi ${finalIcon} fs-5"></i>
                            </div>
                            <div>
                                <div class="fw-bold">${title}</div>
                                <small class="opacity-90">${message}</small>
                            </div>
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = document.getElementById(toastId);
            
            // Add slide-in animation
            toastElement.style.transform = 'translateX(100%)';
            toastElement.style.transition = 'transform 0.3s ease-out';
            
            const toast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: type === 'success' ? 4000 : 6000
            });
            
            // Trigger slide-in animation
            setTimeout(() => {
                toastElement.style.transform = 'translateX(0)';
            }, 100);
            
            toast.show();
            
            // Add pulse effect for success
            if (type === 'success') {
                setTimeout(() => {
                    toastElement.classList.add('pulse-success');
                }, 500);
            }
            
            // Remove toast element after it's hidden
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    toastElement.remove();
                }, 300);
            });
        }
        
        // Legacy toast function for compatibility
        function showToast(type, title, message) {
            showEnhancedToast(type, title, message);
        }
        
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
            return container;
        }
    </script>
</body>
</html>
